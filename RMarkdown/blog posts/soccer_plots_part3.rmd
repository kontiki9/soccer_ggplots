---
title: "Untitled"
author: "RN7"
date: "June 27, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Animating the Goals of the World Cup: Comparing the old vs. new gganimate and tweenr API!


Welcome to Part 3 of my series on Visualizing the World Cup with R! This is the culmination of this mini project that I've been working on throughout the World Cup. In addition, from having listened to Thomas Pedersen's excellent keynote on the NEW gganimate and tweenr API, I am taking advantage of this fortuitous timing to also compare the APIs using the goals as the examples!

I've had finished these a cople of weeks ago but didn't make them publically available until I presented at the TokyoR user group last week! Hadley Wickham and Joe Rickert were the special guests and with the amount of speakers and attendees it felt more like a mini-conference than a regular meetup. You can check out a recording of my talk on [Youtube]()! 


## raison d'etre

Several people have asked me where I got the data. I thought I made it quite clear in Part 1 but I will reiterate in the next few paragraphs.

wonderful visualizations by - - - - -

BUT WAIT

can a average joe like me just waltz in, slap down a fiver and say SO GIMME THE DATA?

NO >>>> costs #`$$$`#

jealous of those who have the financial backing to procure such data and mild annoyance at others who didn't really bother with sharing exactly HOW they got their data I went to work... 

fueled by my desire to make some soccer viz , that no one has seen before...! 

unable to be able to master RSelenium before the World Cup ends when my visualizations would have the most IMPACT and also not being able to win the lottery in that time as well... I did the unthinkable: create the coordinate data positions myself!

![]() thanos I'll do it myself gif

With the easy plotting system in ggsoccer and ggplot2 it's really not that hard to find out the positions yourself as you can see in the picture below

![]() soccer plot positions pic

Of course, there's also a way to make the coordinates be in 120x80 format (which is much more intuitive looking at a rectangular field) and there is an option for it by  ____ . however, i only realized this after I've embedded the positionings for the 100x100 plot in my head so that's what i kept going with. 

There is also the ____ which allows you to mouse-click specific points on the field and then download a .csv file of the coordinates. This might be easier but personally I like to experiment within the R environment and take notes/ideas in RMarkdown as I do so but it definitely is an option for others.

... and that's how [Part 1]() was born! But I wasn't going to stop there, soccer is a moving - flowing game, static images are OK but it just doesn't capture the FEEL of the sport!


## Gazinsky's first goal:

Out of all the World Cup events I've animated so far, by far the most complicated is Gazinsky's goal in the opening game. This is because we not only have the ball movement but player movement as well! Also, by using the new API I wanted to experiment with fading out players who aren't important to the play at certain moments in time. So most of the **comparison** aspect of the APIs will be done with this goal.



## With gganimate + tweenr

Let's take a look at the packages that I'll be using:

```{r packages}
library(ggplot2)    # general plotting base
library(dplyr)      # data manipulation/tidying
library(ggsoccer)   # draw soccer field plot
library(ggimage)    # add soccer ball emoji + flags
library(extrafont)  # incorporate Dusha font into plots
library(gganimate)  # animate goal plots
library(tweenr)     # create in-between frames for data
library(purrr)      # for creating a list of dataframes for tweenr
# loadfonts()         run once every new session
```



```{r echo=FALSE}
# data
pass_data <- data.frame(
  x = c(100, 94, 82, 82.5,  84, 76.5, 75.5, 94, 99.2),       # pass balls
  y = c(0,   35, 31, 22,     8, 13, 19, 60, 47.5),
  time = c(1, 2, 3, 4, 5, 6, 7, 8, 9))

golovin_movement <- data.frame(
  x = c(78, 80, 80, 80, 75.5, 74.5, 73.5, 73, 73),   #75, 74, 73
  y = c(30, 30, 27, 25,   10,    9, 15, 15, 15),
  label = "Golovin",
  time = c(1, 2, 3,  4,  5,  6,  7,  8,  9)
)

zhirkov_movement <- data.frame(
  x = c(98, 90, 84, 84, 84, 84, 84, 84, 84),
  y = c( 0,  2,  2,  2,  2,  2,  2,  2,  2),
  label = "Zhirkov",
  time = c(1, 2, 3, 4, 5, 6, 7, 8, 9)
)

gazinsky_movement <- data.frame(
  x = c(92),
  y = c(66.8),
  label = "Gazinsky",
  time = c(6, 7, 8, 9)
)

# segment golovin should only appear 4-5?
# segment zhirkov should only appear 1-3?
segment_data <- data.frame(
  x = c(77.5, 98),
  y = c(22, 2),
  xend = c(75, 84),
  yend = c(15, 3),
  linetype = c("dashed", "dashed"),
  color = c("black", "black"),
  size = c(1.2, 1.25)
)

saudi_data <- data.frame(
  x = c(95),
  y = c(35),
  label = "M. Al-Breik"
)

### soccer ball
ball_data <- tribble(
  ~x,  ~y, ~time,
  100,   0,   1,
  94,   35,   2,
  82,   31,   3,
  82.5, 25,   4,
  84,    6,   5, 
  77,   13,   6,
  76,   19,   7,
  94,   60,   8,
  99.2, 47.5, 9,
  
) 
```

NOTE: you need to be careful about the ordering of the ggplot elements. You need to make sure the soccer ball emoji code is near the end, after the labels so that the player name labels don't cover the soccer ball as its moving around!

```{r eval=FALSE}
gazin_ani <- ggplot(pass_data) +
  annotate_pitch() +
  theme_pitch() +
  coord_flip(xlim = c(49, 101),
             ylim = c(-1, 101)) +
  geom_segment(data = segment_data, 
               aes(x = x, y = y, 
                   xend = xend, yend = yend),
               size = segment_data$size,
               color = segment_data$color,
               linetype = c("dashed", "dashed")) +
  geom_label(
    data = saudi_data,
    aes(x = x, y = y,
        label = label),
    color = "darkgreen") +
  geom_label(data = zhirkov_movement,
    aes(x = x, y = y,
        frame = time,
        label = label),
    color = "red") +
  geom_label(data = golovin_movement,
    aes(x = x, y = y,
        frame = time,
        label = label),
    color = "red") +
  geom_label(
    data = gazinsky_movement,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  ggimage::geom_emoji(
    data = ball_data,
    aes(x = x, y = y, frame = time),   
    image = "26bd", size = 0.035) +
  ggtitle(label = "Russia (5) vs. (0) Saudi Arabia", 
          subtitle = "First goal, Yuri Gazinsky (12th Minute)") +
  labs(caption = "By Ryo Nakagawara (@R_by_Ryo)") +
  annotate("text", x = 69, y = 65, family = "Dusha V5",
           label = "After a poor corner kick clearance\n from Saudi Arabia, Golovin picks up the loose ball, \n exchanges a give-and-go pass with Zhirkov\n before finding Gazinsky with a beautiful cross!") +
  theme(text = element_text(family = "Dusha V5"))

gganimate(gazin_ani, 
          width = 8, height = 6, 
          title_frame = FALSE,  
          "gazin_ggani_final.gif")


```


Now let's check out how we would do it with tweenr added in!

The important bit with the old API was taht you had to create a list of dataframes of the different states of your data. In this case, it is a dataframe for each row of the data or to put it more simply, the "time" variable (a dataframe of coordinate positions for time = 1, time = 2, etc.). This is done with `pmap()` to create a dataframe for each row. 

With this list of dataframes created, we can pass it into `tween_states()` function to create the in-between frames to connect each of the dataframes in the list. Take note of the arguments in `tweent_states()` as they'll show up again in the new API later.

```{r}
### soccer ball
b_list <- ball_data %>% pmap(data.frame)

ball_tween <- b_list %>% 
  tween_states(tweenlength = 0.5, statelength = 0.00000001, ease = "linear", nframes = 75)

### Golovin

golovin_movement_list <- golovin_movement %>% pmap(data.frame)
  
golovin_tween <- golovin_movement_list %>% 
  tween_states(tweenlength = 0.5, statelength = 0.00000001, ease = "linear", nframes = 75)

golovin_tween <- golovin_tween %>% mutate(label = "Golovin")

### Zhirkov
zhirkov_movement_list <- zhirkov_movement %>% pmap(data.frame)
  
zhirkov_tween <- zhirkov_movement_list %>% 
  tween_states(tweenlength = 0.5, statelength = 0.00000001, ease = "linear", nframes = 75)

zhirkov_tween <- zhirkov_tween %>% mutate(label = "Zhirkov")
```

Now with these newly created tween dataframes, we pass them into our ggplot code as before and specify the frame argument with the newly created `.frame` variable.

```{r tweenr old API}
ggplot(pass_data) +
  annotate_pitch() +
  theme_pitch() +
  coord_flip(xlim = c(49, 101),
             ylim = c(-1, 101)) +
  geom_label(
    data = saudi_data,
    aes(x = x, y = y,
        label = label),
    color = "darkgreen") +
  geom_label(data = zhirkov_tween,
    aes(x = x, y = y,
        frame = .frame,
        label = label),
    color = "red") +
  geom_label(data = golovin_tween,
    aes(x = x, y = y,
        frame = .frame,
        label = label),
    color = "red") +
  geom_label(
    data = gazinsky_movement,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  ggimage::geom_emoji(
    data = ball_tween,
    aes(x = x, y = y, frame = .frame),   
    image = "26bd", size = 0.035) +
  ggtitle(label = "Russia (5) vs. (0) Saudi Arabia", 
          subtitle = "First goal, Yuri Gazinsky (12th Minute)") +
  labs(caption = "By Ryo Nakagawara (@R_by_Ryo)") +
  annotate("text", x = 69, y = 65, family = "Dusha V5",
           label = "After a poor corner kick clearance\n from Saudi Arabia, Golovin picks up the loose ball, \n exchanges a give-and-go pass with Zhirkov\n before finding Gazinsky with a beautiful cross!") +
  theme(text = element_text(family = "Dusha V5"))
```


Overall

Now let's check out how things changed with the new API!



## With NEW gganimate + tweenr

Once again, Let's start by looking at just animating across the time variable without creating in-between grames.

it's quite nice that I don't have to specify "frame = time_variable" in every geom that I want animated now!

```{r}
ggplot(pass_data) +
  annotate_pitch() +
  theme_pitch() +
  theme(text = element_text(family = "Dusha V5")) +
  coord_flip(xlim = c(49, 101),
             ylim = c(-1, 101)) +
  geom_segment(
    data = segment_data, 
    aes(x = x, y = y, 
        xend = xend, yend = yend),
    size = segment_data$size,
    color = segment_data$color,
    linetype = c("dashed", "dashed")) +
  geom_label(
    data = zhirkov_movement,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  geom_label(
    data = golovin_movement,
    aes(x = x, y = y,
        label = label),
    color = "red") + 
  geom_label(
    data = gazinsky_movement,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  geom_label(
    data = saudi_data,
    aes(x = x, y = y,
        label = label),
    color = "darkgreen") +
  ggimage::geom_emoji(
    data = ball_data,
    aes(x = x, y = y),   
    image = "26bd", size = 0.035) +
  ggtitle(label = "Russia (5) vs. (0) Saudi Arabia", 
          subtitle = "First goal, Yuri Gazinsky (12th Minute)") +
  labs(caption = "By Ryo Nakagawara (@R_by_Ryo)") +
  annotate("text", x = 69, y = 65, family = "Dusha V5",
           label = "After a poor corner kick clearance\n from Saudi Arabia, Golovin picks up the loose ball, \n exchanges a give-and-go pass with Zhirkov\n before finding Gazinsky with a beautiful cross!") +
  transition_manual(time)

```

However, you can see that like in the old gganimate code, `transition_manual()` just speeds through the time variable without actually creating in-between frames. Now let's use the other `transition_*()` functions to specify the tween frames and slow the animation down a bit!


```{r}
pass_data <- data.frame(
  x = c(100, 94, 82, 82.5),       # pass balls
  y = c(0,   35, 31, 22),
  time = c(1, 2, 3, 4))

golovin_movement <- data.frame(
  x = c(78, 80, 80, 80),   
  y = c(30, 30, 27, 25),
  label = "Golovin",
  time = c(1, 2, 3,  4)
)

zhirkov_movement <- data.frame(
  x = c(98, 90, 84, 84),
  y = c( 0,  2,  2,  2),
  label = "Zhirkov",
  time = c(1, 2, 3, 4)
)

gazinsky_movement <- data.frame(
  x = c(92),
  y = c(66.8),
  label = "Gazinsky"
)

# saudi defender
saudi_data <- data.frame(
  x = c(95),
  y = c(35),
  label = "M. Al-Breik"
)

### soccer ball
ball_data <- tribble(
  ~x,  ~y, ~time,
  100,   0,   1,
  94,   35,   2,
  82,   31,   3,
  82.5, 25,   4,
) 

## THIS WORKS USE THIS.
b_list <- ball_data %>% pmap(data.frame)

ball_tween <- b_list %>% 
  tween_states(tweenlength = 0.5, statelength = 0.0001, ease = "linear", nframes = 75)

### Golovin

golovin_movement_list <- golovin_movement %>% pmap(data.frame)
  
golovin_tween <- golovin_movement_list %>% 
  tween_states(tweenlength = 0.5, statelength = 0.0001, ease = "linear", nframes = 75)

golovin_tween <- golovin_tween %>% mutate(label = "Golovin")

### Zhirkov
zhirkov_movement_list <- zhirkov_movement %>% pmap(data.frame)
  
zhirkov_tween <- zhirkov_movement_list %>% 
  tween_states(tweenlength = 0.5, statelength = 0.0001, ease = "linear", nframes = 75)

zhirkov_tween <- zhirkov_tween %>% mutate(label = "Zhirkov")


```


now use tweenr

```{r}
ggplot(pass_data) +
  annotate_pitch() +
  theme_pitch() +
  coord_flip(xlim = c(49, 101),
             ylim = c(-1, 101)) +
  geom_label(
    data = saudi_data,
    aes(x = x, y = y,
        label = label),
    color = "darkgreen") +
  geom_label(
    data = zhirkov_tween,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  geom_label(
    data = golovin_tween,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  geom_label(
    data = gazinsky_movement,
    aes(x = x, y = y,
        label = label),
    color = "red") +
  ggimage::geom_emoji(
    data = ball_tween,
    aes(x = x, y = y),   
    image = "26bd", size = 0.035) +
  ggtitle(label = "Russia (5) vs. (0) Saudi Arabia", 
          subtitle = "First goal, Yuri Gazinsky (12th Minute)") +
  labs(caption = "By Ryo Nakagawara (@R_by_Ryo)") +
  annotate("text", x = 69, y = 65, family = "Dusha V5",
           label = "After a poor corner kick clearance\n from Saudi Arabia, Golovin picks up the loose ball, \n exchanges a give-and-go pass with Zhirkov\n before finding Gazinsky with a beautiful cross!") +
  theme(text = element_text(family = "Dusha V5")) +
  transition_states(.frame, 
                    transition_length = 0.5, 
                    state_length = 0.0001) +
  enter_fade() +
  exit_shrink() +
  ease_aes("linear")



```



## Personal thoughts:

no intermediary steps >> if you have the time var you dont have to manually go and create the list of dataframe for each state yourself >>> transition_states() does it all for you in the ggplot code!!
dont have to deal with list dataframes and creating them and the extra step hassle of using tween)states() tunfction

made the mistake of runnign through the tween_states funs and THEN putting everything through transition_states again so it made everything weird...



## Osako's goal vs. Colombia

```{r}
cornerkick_data <- data.frame(x = 99, y = 0.3,
                              x2 = 94, y2 = 47)

osako_gol <- data.frame(x = 94, y = 49,
                        x2 = 100, y2 = 55.5)

ball_data <- data.frame(x = c(99, 94, 100),
                        y = c(0.3, 47, 55.5),
                        time = c(1, 2, 3))

player_label <- data.frame(x = c(92, 99), 
                           y = c(49, 2))

wc_logo <- data.frame(x = 107,
                       y = 85) %>% 
  mutate(image = "https://upload.wikimedia.org/wikipedia/en/thumb/6/67/2018_FIFA_World_Cup.svg/1200px-2018_FIFA_World_Cup.svg.png")
```

tweenr

```{r}
ggplot(ball_data) +
  annotate_pitch() +
  theme_pitch() +
  theme(text = element_text(family = "Dusha V5")) +
  coord_flip(xlim = c(55, 112),
             ylim = c(-1, 101)) +
  geom_label(data = player_label, 
             aes(x = x, y = y),
             label = c("Osako", "Honda"), family = "Dusha V5") +
  geom_point(aes(x = 98, y = 50), size = 3, color = "green") +
  annotate(geom = "text", family = "Dusha V5", 
           hjust = c(0.5, 0.5, 0.5, 0.5),
           size = c(6.5, 4.5, 5, 3),
           label = c("Japan             (2) vs. Colombia             (1)",
                     "Kagawa (PEN 6'), Quintero (39'), Osako (73')",
                     "Japan press their man advantage, substitute Honda\ndelivers a delicious corner kick for Osako to (somehow) tower over\nColombia's defense and flick a header into the far corner!",
                     "by Ryo Nakagawara (@R_by_Ryo)"),
           x = c(110, 105, 70, 53), 
           y = c(30, 30, 47, 85)) +
  ggimage::geom_emoji(aes(x = x, 
                          y = y),
             image = "26bd", size = 0.035) +
  ggimage::geom_flag(aes(image = "JP"),       # Japan Flag
            x = 110, y = 13, size = 0.08) +
  ggimage::geom_flag(aes(image = "CO"),       # Colombia Flag
            x = 110, y = 53, size = 0.08) +
  geom_image(data = wc_logo,
             aes(x = x, y = y,
                 image = image), size = 0.17) +
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm")) +
  transition_states(time, 
                    transition_length = 1.5, 
                    state_length = 0.01) +
  ease_aes("quadratic-out")


```


## Japan's Offside Trap!

```{r osako data}
# PLAYERS
# JAPAN: x, y (blue)     Senegal: x2, y2  (lightgreen)
# push 2, 3 frames up above box >>> add 5, 6 as frames??
trap_data <- data.frame(
  
  time = c(1, 2, 3, 4, 5),
  
  # ball trajectory
  x = c(70, 70, 70, 87, 95),       # pass balls
  y = c(85, 85, 85, 52, 33),
  
  # offside bar
  #xo =    c(83, 81.2, 79, 77.5, 70),
  xoend = c(83.8, 81.8, 79, 78.5, 71),
  
  yo =    c( 5,  5,  5,  5, 5),
  yoend = c(95, 95, 95, 95, 95),
  
  # players: japan
  jx  = c(83, 81, 77, 75, 70),
  jy  = c(rep(65, 5)),
  
  jx2 = c(83, 81.8, 78.5, 77, 70),
  jy2 = c(rep(60.5, 5)),
  
  jx3 = c(83, 81, 76.5, 75, 71),
  jy3 = c(rep(55, 5)),
  
  jx4 = c(83, 81.2, 76.3, 75, 70),
  jy4 = c(rep(52, 5)),
  
  jx5 = c(82.8, 81, 77, 74, 70),
  jy5 = c(rep(49, 5)),
  
  jx6 = c(83, 81.8, 77, 74, 70),
  jy6 = c(rep(45, 5)),

  jx7 = c(83.8, 81, 79, 77.5, 70),
  jy7 = c(rep(40, 5)),
  
  # players: senegal
  sx = c(83, 84, 84, 84, 84),
  sy = c(rep(33, 5)),
  
  sx2 = c(83, 85, 87, 92, 95),
  sy2 = c(38, 37, 35, 34, 33),
  
  sx3 = c(83, 84, 84, 83, 83),
  sy3 = c(rep(41, 5)),
  
  sx4 = c(83, 84, 83, 78, 78),
  sy4 = c(rep(45, 5)),
  
  sx5 = c(83, 84, 87, 88, 89),
  sy5 = c(rep(52, 5)),
  
  sx6 = c(83, 85, 84, 84, 83),
  sy6 = c(rep(69, 5))
)


# flags
flag_data <- data.frame(
  x = c( 42, 72),
  y = c(107, 107),
  team = c("japan", "senegal")
  ) %>% 
  mutate(
    image = team %>% 
           countrycode(., origin = "country.name", destination = "iso2c")
  ) %>% 
  select(-team)

# extra players:
goalkeeper_data <- data.frame(
  
  x = c(98),
  y = c(50)
  
)

senegal_data <- data.frame(
  
  x = c(55, 55, 68.5),
  y = c(50, 60, 87)
  
)


```


take note of the "wrap" option, set it to false if you don't want the last state to transition back to the first frame (default == TRUE).

```{r tweenr offside NEW, fig.height=10, fig.width=8}
ggplot(trap_data) +
  annotate_pitch() +
  theme_pitch(aspect_ratio = NULL) +
  coord_fixed(xlim = c(30, 101),
       ylim = c(-5, 131)) +
  # offside line
  geom_segment(aes(x = xoend, y = yo, 
                   xend = xoend, yend = yoend,
                   frame = time), 
               color = "black", size = 1.3) +
  # start at 83      just use geom_segment instead
  # japan
  geom_point(aes(x = jx, y = jy), size = 4, color = "blue") +
  geom_point(aes(x = jx2, y = jy2), size = 4, color = "blue") +
  geom_point(aes(x = jx3, y = jy3), size = 4, color = "blue") +
  geom_point(aes(x = jx4, y = jy4), size = 4, color = "blue") +
  geom_point(aes(x = jx5, y = jy5), size = 4, color = "blue") +
  geom_point(aes(x = jx6, y = jy6), size = 4, color = "blue") +
  geom_point(aes(x = jx7, y = jy7), size = 4, color = "blue") +
  # senegal
  geom_point(aes(x = sx, y = sy), size = 4, color = "green") +
  geom_point(aes(x = sx2, y = sy2), size = 4, color = "green") +
  geom_point(aes(x = sx3, y = sy3), size = 4, color = "green") +
  geom_point(aes(x = sx4, y = sy4), size = 4, color = "green") +
  geom_point(aes(x = sx5, y = sy5), size = 4, color = "green") +
  geom_point(aes(x = sx6, y = sy6), size = 4, color = "green") +
  
  # free kick spot (reference)
  geom_point(aes(x = 70, y = 85), color = "blue", size = 1.2) +
  annotate(geom = "text", family = "Dusha V5", 
           hjust = c(0, 0, 0, 0.5),
           size = c(4.5, 3, 5.5, 3),
           label = c("Japan             (2) vs. Senegal             (2)",
                     "Mane (11'), Inui (33'), Wague (71'), Honda (78')",
                     "The Perfect Offside Trap",
                     "by Ryo Nakagawara\n(@R_by_Ryo)"),
           x = c(30, 30, 30, 94), 
           y = c(117, 108, 125, -3)) +
  ggimage::geom_flag(data = flag_data,
                     aes(x = x, y = y,
                         image = image),       
                     size = c(0.08, 0.08)) +
  ggimage::geom_emoji(aes(x = x, y = y),
                      image = "26bd", size = 0.035) +
  transition_states(states = time, 
                    transition_length = 0.5, 
                    state_length = 0.00000001,
                    wrap = FALSE) +
  ease_aes("linear")

```







+ the meme generator with R

```{r meme eval=FALSE}
library(memery)
img <- ("https://imgflip.com/s/meme/Roll-Safe-Think-About-It.jpg")

meme_labs <- c("you can't lose the aerial battle", "if you set an offside trap")

meme(img, meme_labs, "offside_meme.png")

```







and finally just as an extra...



```{r}

```

